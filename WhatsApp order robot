from flask import Flask, request
import requests
from twilio.twiml.messaging_response import MessagingResponse
import pandas as pd
import warnings
import numpy as np
warnings.filterwarnings("ignore")
app = Flask(__name__)

total_list = []
order_list = []
toexcel = []
dict2list = []
dict4list = []
i = 0

@app.route('/bot', methods=['POST'])
def bot():

    file_path1 = "/Users/chunghimlau/Desktop/Python/ck.xlsx"
    file_path2 = "/Users/chunghimlau/Desktop/Python/ck.xlsx"
    file_path3 = "/Users/chunghimlau/Desktop/Python/ck.xlsx"
    file_path4 = "/Users/chunghimlau/Desktop/Python/ck.xlsx"
    #build dataframe
    #Replace null value by ""
    #Replace "<-" by ""
    df1 = pd.read_excel(file_path1,sheet_name = "code_id_price")
    df1 = df1.replace(np.nan,"")
    df1 = df1.replace("<-","")
    df2 = pd.read_excel(file_path2,sheet_name = "code_color")
    df2 = df2.replace(np.nan,"")
    df2 = df2.replace("<-","")
    df3 = pd.read_excel(file_path3,sheet_name = "code_product_name")
    df3 = df3.replace(np.nan,"")
    df3 = df3.replace("<-","")
    df4 = pd.read_excel(file_path4,sheet_name = "code_size")
    df4 = df4.replace(np.nan,"")
    df4 = df4.replace("<-","")
    print(df1.columns)
    print(df2.columns)
    print(df3.columns)
    print(df4.columns)
   
        
    #set key = id value = column(list all value)
    dict1 = df1.set_index('excel_item_id').T.to_dict('list')
    dict2 = df2.set_index('itemcolour_id').T.to_dict('list')
    dict3 = df3.set_index('item_name_id').T.to_dict('list')
    dict4 = df4.set_index('item_name_id').T.to_dict('list')
    #print(dict1)
    #print(dict2)
    #print(dict3)
    #print(dict4)
   
    
    
    incoming_msg = request.values.get('Body', '')
    resp = MessagingResponse()
    msg = resp.message()
    responded = False
    global total_list
# Incoming_msg == "order"
    if "order" in incoming_msg:
        order_list.clear()
        total_list.clear()
        toexcel.clear()
        quote = "ã€Šè«‹è¼¸å…¥å•†å“ç·¨è™Ÿã€‹\n\n*è‹¥è¦çµç®—è«‹è¼¸å…¥ done\n\n"
        msg.body(quote)
        responded = True
        
# Incoming_msg not equal to "order"        
    if incoming_msg != "order":
        try:
            #check if it is number or string
            #check if it is item_code 101,102,103....
            item_key = incoming_msg

            id_num = int(item_key)
            if id_num in dict1:
                
                dict2list.clear()
                for item in dict2[id_num]:
                    if item != "":
                        dict2list.append(item)
                    
                quo = "å•†å“åç¨±: "+str(dict3[id_num]),"\né¡è‰² â¡ï¸"+str(dict2list)+"\nä½ æƒ³è¦å’©é¡è‰² "
                quote =  ''.join(quo)
                order_list.append(id_num)
                toexcel.append(dict3[id_num][0])
                
                print("Order List",order_list)
                #print("Total = ",total_list)
                msg.body(quote)
                responded = True
            else:
                quote = "ğŸ¤”ä½ æ‰“å˜…å•†å“ç·¨è™Ÿå””å•±å•µ!è©¦å¤šä¸€æ¬¡~ğŸ¤”"
                print(quote)
                msg.body(quote)
                responded = True
        except:
            if incoming_msg != "done" and len(order_list) > 0:
            
                input_color = incoming_msg
                output_color = input_color+"è‰²"
                
                global i
                print("I = ",i)
                id_num = order_list[i]
                if input_color in dict2[id_num]:
                    order_list.append(output_color)
                    toexcel.append(output_color)
                    print("Order List",order_list)
                    #print("Total = ",total_list)
                    dict4list.clear()
                    for item in dict4[id_num]:
                        if item != "":
                            dict4list.append(item.upper())
                    quo = "Size â¡ï¸"+str(dict4list)+"\nä½ æƒ³è¦å’©Size "
                    quote = ''.join(quo)
                    msg.body(quote)
                    responded = True
                else:

                    if incoming_msg.lower() != "s" and incoming_msg.lower() != "m" and incoming_msg.lower() != "l" and incoming_msg.lower() != "xl" and incoming_msg.lower() != "done":
                        if len(order_list)%3 == 1 or len(order_list) == 1 :
                            quote = "ğŸ¤”å¥½ä¼¼ä»¶è¡«å†‡ä½ æ€æœéš»é¡è‰²å•µ!è©¦å¤šä¸€æ¬¡~ğŸ¤”"
                            print(quote)
                            msg.body(quote)
                            responded = True
                        else:

                            if incoming_msg.lower() != "s" and incoming_msg.lower() != "m" and incoming_msg.lower() != "l" and incoming_msg.lower() != "xl":
                                if len(order_list)%3 == 2 or len(order_list) == 2:
                                    quote = "ğŸ¤”å¥½ä¼¼ä»¶è¡«å†‡å‘¢å€‹Sizeå•µ!è©¦å¤šä¸€æ¬¡~ğŸ¤”"
                                    print(quote)
                                    msg.body(quote)
                                    responded = True
            else:
                responded = False
                
                
    if incoming_msg.lower() == "s" or incoming_msg.lower() == "m" or incoming_msg.lower() == "l" or incoming_msg.lower() == "xl" or incoming_msg.lower() == "free":

        id_num = order_list[i]
        if incoming_msg.lower() in dict4[id_num]:
            order_list.append(incoming_msg.upper())
            toexcel.append(incoming_msg.upper())
            print("Order List",order_list)
            #print("Total = ",total_list)
            price = dict1[id_num][0]
            total_list.append(int(price))
            print("Total = ",total_list)
            
            i += 3
            print("I = ",i)
            quo = "ä»²æœ‰å†‡å…¶ä»–ï¼Ÿæœ‰å°±å†æ‰“å¤šæ¬¡item code!","\nåŸ‹å–®å°±æ‰“done"
            quote =  ''.join(quo)
            msg.body(quote)
            responded = True
    if incoming_msg == "done":
        
        print(total_list)
        out_total = []
        out_total = total_list.copy()
        out_total = str(sum(out_total))
        #id_num = order_list[i]
        #output_color = order_list[1]
        #output_size = order_list[2]
        quo = "ğŸ‘¦ğŸ»CheckoreanğŸ‡°ğŸ‡·ä»˜æ¬¾æ–¹æ³• ğŸ‘§ğŸ»\n-é€¢æ˜ŸæœŸå››æˆªå–®-\næœªå…¥æ•¸å˜…æœ‰æ©Ÿæœƒæœƒå†‡è²¨ğŸ¤®è¨˜ä½å¿«å•²å…¥\nå…¥å®Œæ•¸å†‡è²¨å˜…è©±åº—ä¸»æœƒè¦ªè‡ªè¯çµ¡é€€æ¬¾å®‰æ’ğŸ¤ğŸ»\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nğŸ’°",out_total,"\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nâ€¼ï¸å…¥æ•¸ä¹‹å¾Œâ€¼ï¸\nè«‹å°‡æ”¶æ“šè¨¼æ˜sendä¿¾æˆ‘åœ°ğŸ˜›\nThankyouuu~\n1âƒ£åŒ¯è±éŠ€è¡Œ\n661-324-574-833\n2ï¸âƒ£è½‰æ•¸å¿«/ PAYME\n+852 64874030ï¼ˆâš ï¸æ³¨æ„ï¼‰\nhttps://payme.hsbc/checkorean\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nğŸ”¥å–è²¨ä¿¡æ¯ğŸ”¥ è«‹æŒ‰ä»¥ä¸‹æ ¼å¼å¡«å¯«\n1âƒ£ï¸.é †è±åˆ°ä»˜ ( æ™ºèƒ½æ«ƒ / SFé–€å¸‚ )\nğŸ§šğŸ»â€â™€ï¸æ”¶ä»¶äºº: Karen Lau \nâ˜ï¸Tel: 56265394\n é †è±ç·¨ç¢¼: 852UA27P\n2âƒ£ï¸.å¹³éƒµ(é©ç”¨æ–¼è³¼ç‰©æ»¿$300ä»¥ä¸Š\nğŸŒŸè¨»ï¼šéƒµè²»å°‡æ–¼å¯„è²¨å¾Œå†å‘å®¢äººæ”¶å–\nğŸ§šğŸ»â€â™€ï¸æ”¶ä»¶äºº: Karen Lau\n â˜ï¸Tel: 56265394\nåœ°å€: xxxxxxxxxxxx\nâ€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\nâš ï¸é¡§å®¢é ˆçŸ¥\n1âƒ£ï¸æ­¤ç‚ºé è¨‚å•†å“ æˆªå–®å¾Œ2-3æ˜ŸæœŸå‡ºè²¨ è«‹è€å¿ƒç­‰å¾…âŒ›ğŸ™ğŸ»\n2âƒ£ï¸è‹¥å‡ºç¾è½å–®å¾Œç¼ºè²¨ç­‰æƒ…æ³ æœƒå‘å®¢äººé€€å›è©²å•†å“å…¨æ•¸æ¬¾é …\n3âƒ£ï¸å°åº—æœƒè¦ªè‡ªè¯çµ¡é¡§å®¢é€€æ¬¾å®‰æ’ğŸ¥º\n \nå¤šè¬ä½ å˜…æ”¯æŒğŸ™ˆä½ å˜…æ”¯æŒæœƒæˆç‚ºæˆ‘åœ°å˜…å‹•åŠ›ğŸ¤"
        quote =  ''.join(quo)
        i = 0
        #a = "OKOKOK"
        #msg.body(order_list[0])
        #first = str(dict3[id_num][0])
        out_df = pd.DataFrame([toexcel])
        from openpyxl import load_workbook
        # new dataframe with same columns
        writer = pd.ExcelWriter('/Users/chunghimlau/Desktop/Python/ck.xlsx',sheet_name = "orderlist", engine='openpyxl')
        # try to open an existing workbook
        writer.book = load_workbook('/Users/chunghimlau/Desktop/Python/ck.xlsx')
        # copy existing sheets
        writer.sheets = dict((ws.title, ws) for ws in writer.book.worksheets)
        # read existing file
        reader = pd.read_excel(r'/Users/chunghimlau/Desktop/Python/ck.xlsx',sheet_name = "orderlist")
        # write out the new sheet
        out_df.to_excel(writer,sheet_name = "orderlist",index=False,header=False,startrow=len(reader)+1)

        writer.close()
        msg.body(quote)
        #msg.body(first)
        #msg.body(output_color)
        #msg.body(output_size)
        
        responded = True

    if not responded:

        #msg.body('I only know about famous quotes and cats, sorry!')
        pass
    return str(resp)

     
    
if __name__ == '__main__':
    app.run()   


  
